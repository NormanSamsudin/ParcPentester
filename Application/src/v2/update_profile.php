<!DOCTYPE html>
<head>
<?php if(isset($_COOKIE['stylesheet'])) include($_COOKIE['stylesheet']);?>
</head>
<body>
<?php
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

include 'function.php';
include 'security/filter.php';
include 'constant/define1.php';

$exec = new exec_proc;
$security = new Security;

$update = $exec -> database($host,$username,$password,$database);
if(isset($_POST['id']) && isset($_POST['usr_sess']))
{
    $cid = mysqli_real_escape_string($update,$_POST['id']);
    $usrss = mysqli_real_escape_string($update,$_POST['usr_sess']);
    $sess = "SELECT * FROM session_ WHERE member_id='$cid' AND session_id='$usrss'";
    $sessf = $update->query($sess) or die($update->error);
    $rses = $sessf->fetch_assoc();
}

if(isset($_POST['id']) && isset($rses['main_id']))
{
   $id = mysqli_real_escape_string($update,$_POST['id']);
   $query = "SELECT * FROM members where member_id=$id";
   $fetch = $update->query($query) or die($update->error);
   $data = $fetch->fetch_assoc();
   $_SESSION['XSRF'] = sha1(bin2hex(mt_rand(999,99999)));
        $member_id = $data['member_id'];
        //$avatar = htmlentities($data['avatar']);
        $name = htmlentities($data['name']);
        $email = htmlentities($data['email']);
        $noic = htmlentities($data['icno']);
        $notel = htmlentities($data['notel']);
        $born = htmlentities($data['bornyear']);
        $addr = htmlentities($data['address']);

        ?>
        <center>
        <img src='photo.php?pid=<?php echo $member_id;?>' width='150px' height='150px'>
        <form action='' method='POST' enctype='multipart/form-data'>
        <input type='hidden' name='photo_id' value='<?php echo $member_id; ?>'>
        <input type='hidden' name='token' value='<?php echo $_SESSION['XSRF']; ?>'>
        <input type='file' name='avatar'><input type='submit' name='upload_photo' value='Change Photo'>
        </form>
        <form action='' method='POST'><table>
        <tr><td><label>Name </label></td><td>:<input type='text' name='name' value='' placeholder='<?php echo $name;?>'></td></tr>
        <tr><td><label>Email </label></td><td>:<input type='text' name='email' value='' placeholder='<?php echo $email;?>'></td></tr>
        <tr><td><label>Gender <label></td>
        <td>:<select name='gender'>
        <option value='' default>Choose your gender</option>
        <option value='M'>Male</option>
        <option value='F'>Female</option>
        <option value='O'>Sajat</option>
        </select></td></tr>
        <tr><td><label>No IC </label></td><td>:<input type='text' name='icno' value='' placeholder='<?php echo $noic;?>'></td></tr>
        <tr><td><label>No Tel. </label></td><td>:<input type='text' name='notel' value='' placeholder='<?php echo $notel;?>'></td></tr>
        <tr><td><label>Born Year </label></td><td>:<input type='text' name='bornyear' value='' placeholder='<?php echo $born;?>'></td></tr>
        <tr><td><label>Address </label></td><td>:<textarea name='address' value='' placeholder='<?php echo $addr;?>'></textarea></td></tr>
        <tr><td><input type='hidden' name='mid' value='<?php echo $id; ?>'></td>
        <td><input type='submit' name='update' value='Update'></td></tr></table></form>
        <button style='position:absolute;bottom:20px;cursor:pointer;' onclick='backs()'>Kembali</button>
        <script>
        function backs()
        {
            window.history.back();
        }
        </script>
        </center>
        <?php
}

if(isset($_POST['update']) && isset($_SESSION['user_session']))
{
    $mid = $_POST['mid'];
    $qry = "SELECT * FROM members where member_id='$mid'";
    $res = $update->query($qry);
    $row = $res->fetch_assoc();

    $name = $security->update_filter($update,$_POST['name'],$mid,_NAME_);
    $email = $security->update_filter($update,$_POST['email'],$mid,_MAIL_);
    $gender = $security->update_filter($update,$_POST['gender'],$mid,_SEX_);
    $noic = $security->update_filter($update,$_POST['icno'],$mid,_ICNO_);
    $notel = $security->update_filter($update,$_POST['notel'],$mid,_TELP_);
    $born = $security->update_filter($update,$_POST['bornyear'],$mid,_BORN_);
    $addr = $security->update_filter($update,$_POST['address'],$mid,_ADDR_);

    $query = "UPDATE members SET name='$name',email='$email',gender='$gender',icno='$noic',notel='$notel',bornyear='$born',address='$addr' WHERE member_id='$mid'";
    $result = $update -> query($query) or die($update->error);
    echo PR_UPD;
}
if(isset($_POST['upload_photo']) && ($_POST['token']==$_SESSION['XSRF']))
{
    $fid = mysqli_real_escape_string($update,$_POST['photo_id']);
    $filename = $_FILES['avatar']['name'];
    $filetype = $_FILES['avatar']['type'];
    $path = "avatars/".$fid."/";
    $stored = $path.basename($filename);
    unset($_SESSION['XSRF']);
    if(!file_exists($path))
    {
        mkdir("avatars/".$fid);
        if($exec->mime_type($filename,$filetype))
        {
          @move_uploaded_file($_FILES['avatar']['tmp_name'],$stored);
          $cmd = "UPDATE members SET avatar='$stored' WHERE member_id='$fid'";
          $prc = $update -> query($cmd) or die($update->error);
          echo UP_SUC;
        }
        else
        {
            echo UP_ERR;
        }
    }
    else
    {
        unset($_SESSION['XSRF']);
        if($exec->mime_type($filename,$filetype))
        {
          $cmd2 = "SELECT avatar FROM members WHERE member_id='$fid'";
          $prc2 = $update -> query($cmd2) or die($update->error);
          $rw2 = $prc2->fetch_assoc();
          
          if($rw2['avatar']!="avatars/default.png")
          {
            unlink($rw2['avatar']);
          }
          
          if(move_uploaded_file($_FILES['avatar']['tmp_name'],$stored))
          {
            $cmd = "UPDATE members SET avatar='$stored' WHERE member_id='$fid'";
            $prc = $update -> query($cmd) or die($update->error);
            echo UP_SUC;
          }
          else
          {
            echo UP_ERR;
          }
          
        }
        else
        {
            echo UP_ERR;
        }
    }
    
}
?>
</body>
</html>