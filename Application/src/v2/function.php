<?php
session_start();
include('config.php');
class exec_proc{
    private $user,$pass;
    private $session;
    private $json;

    function database($host,$username,$password,$database)
    {
      $conn = new mysqli($host,$username,$password,$database);
      if($conn->connect_error)
       {
        echo "Fail to connect!";
       }
       else
       {
           return $conn;
       }
    }

   function logout()
   {
       unset($_SESSION['user_session']);
       unset($_SESSION['member_id']);
       unset($_SESSION['members']);
       unset($_SESSION['name']);
       unset($_SESSION['id']);
       session_destroy();
       echo "<script>
       Swal.fire(
        'Bye!',
        'You are logged out!',
        'success')
         setTimeout(function() { window.location.replace('login.php') },1500)</script>";
   }

   function mime_type($filename,$filetype)
   {
    $file = pathinfo($filename);

    $type = array('image/jpeg','image/png','image/gif');
    $mimetype = array('jpg','png','jpeg','bmp','gif');


    if(in_array($file['extension'],$mimetype) && in_array($filetype,$type))
    {
        return true;
    }
    else
    {
        return false;
    }
   }

   function privacy_control($id,$sql)
   {
       $pcmd = "SELECT * FROM privacy WHERE main_id=$id";
       $pfetch = $sql->query($pcmd) or die($sql->error);
       $prow = $pfetch->fetch_assoc();
       $checked1 = ''; $checked11 = 'checked';
       $checked2 = ''; $checked22 = 'checked';
       $checked3 = ''; $checked33 = 'checked';
       $checked4 = ''; $checked44 = 'checked';
       if($prow['addr']==1)
       {
           $checked1 = 'checked';
           $checked11 = '';
       }
       if($prow['bornyr']==1)
       {
           $checked2 = 'checked';
           $checked22 ='';
       }
       if($prow['email']==1)
       {
           $checked3 = 'checked';
           $checked33 = '';
       }
       if($prow['notel']==1)
       {
           $checked4 = 'checked';
           $checked44 = '';
       }

       echo "<center><form action='' method='POST'><table>";
       echo "<tr><td><label>Show address? </td></label><td>: </td>";
       echo "<td><input type='radio' id='addr1' name='address' value='1' $checked1 required></td>";
       echo "<td><label for='addr1'>Yes</label></td>";
       echo "<td><input type='radio' id='addr0' name='address' value='0' $checked11 required></td>";
       echo "<td><label for='addr0'>No</label></td></tr>";

       echo "<tr><td><label>Show Year? </td></label><td>: </td>";
       echo "<td><input type='radio' id='brn1' name='bornyear' value='1' $checked2 required></td>";
       echo "<td><label for='brn1'>Yes</label></td>";
       echo "<td><input type='radio' id='brn0' name='bornyear' value='0' $checked22 required></td>";
       echo "<td><label for='brn0'>No</label></td></tr>";

       echo "<tr><td><label>Show Email? </td></label><td>: </td>";
       echo "<td><input type='radio' id='email1' name='email' value='1' $checked3 required></td>";
       echo "<td><label for='email1'>Yes</label></td>";
       echo "<td><input type='radio' id='email0' name='email' value='0' $checked33 required></td>";
       echo "<td><label for='email0'>No</label></td></tr>";

       echo "<tr><td><label>Show No Tel? </td></label><td>: </td>";
       echo "<td><input type='radio' id='notel1' name='notel' value='1' $checked4 required></td>";
       echo "<td><label for='notel1'>Yes</label></td>";
       echo "<td><input type='radio' id='notel0' name='notel' value='0' $checked44 required></td>";
       echo "<td><label for='notel0'>No</label></td></tr></table>";
       
       //echo "<label onclick=javascript:window.location.replace('index.php')>Kembali</label>";
       echo "<tr><td></td><td><input type='submit' name='up_priv' value='Update' style='margin-top:10px;cursor:pointer;'></td></tr>";
       echo "</form></center>";

       if(isset($_POST['up_priv']))
       {
        //$address = $this->filtration($_POST['address']);
        //$bornyear = $this->filtration($_POST['bornyear']);
        //$email = $this->filtration($_POST['email']);
        //$notel = $this->filtration($_POST['notel']);
           //$address = mysqli_real_escape_string($sql,$_POST['address']);
           //$bornyear = mysqli_real_escape_string($sql,$_POST['bornyear']);
           //$email = mysqli_real_escape_string($sql,$_POST['email']);
           //$notel = mysqli_real_escape_string($sql,$_POST['notel']);

           $address = ($_POST['address']);
           $bornyear = ($_POST['bornyear']);
           $email = ($_POST['email']);
           $notel = ($_POST['notel']);

           $p_cmd = "UPDATE privacy SET addr='$address',bornyr='$bornyear',email='$email',notel='$notel' WHERE main_id='$id'";
           $p_fetch = $sql->query($p_cmd) or die($sql->error);
           echo "<script>
           Swal.fire({
            position: 'top-end',
            icon: 'success',
            title: 'Your privacy updated!',
            showConfirmButton: false,
            timer: 1500
          })
          setTimeout(function(){ window.location.replace('index.php?action=privacy') },1000);</script>";
       }
   }
   function register($sql,$user,$pass,$icno,$email,$gender,$bornyear,$address,$notel,$name,$avatar,$member_id)
   {
    //include('email.php');
    $user1=mysqli_real_escape_string($sql,$user);
    $pass1=mysqli_real_escape_string($sql,$pass);
    $icno1=mysqli_real_escape_string($sql,$icno);
    $email1=mysqli_real_escape_string($sql,$email);
    $bornyear1=mysqli_real_escape_string($sql,$bornyear);
    $address1=mysqli_real_escape_string($sql,$address);
    $notel1=mysqli_real_escape_string($sql,$notel);
    $name1=mysqli_real_escape_string($sql,$name);
    $avatar1=mysqli_real_escape_string($sql,$avatar);
    $member_id1=mysqli_real_escape_string($sql,$member_id);
    $gender1=mysqli_real_escape_string($sql,$gender);

       $rcmd = "SELECT id FROM members WHERE user='$user1' OR email='$email1'";
       $rfetch = $sql->query($rcmd);
       $rrow = $rfetch->fetch_assoc();
           if(isset($rrow['id']))
           {
               echo "<script>alert('User/Email already exist!');setTimeout(function() { window.location.replace('register.php'); } ,500);</script>";
           }
           else
           {
               $reg = "INSERT INTO members(user,pass,icno,email,gender,bornyear,address,notel,name,avatar,member_id,activate) VALUES('$user1','$pass1','$icno1','$email1','$gender1','$bornyear1','$address1','$notel1','$name1','$avatar1','$member_id1','0')";
               $reg_fetch = $sql->query($reg) or die($sql->error);

               $check = "SELECT id FROM members WHERE user='$user1' AND email='$email1'";
               $check_fetch = $sql->query($check) or die($sql->error);
               $row_check = $check_fetch->fetch_assoc();
               $main_id = $row_check['id'];

               $reg1 = "INSERT INTO privacy(main_id,member_id,addr,bornyr,email,notel) VALUES($main_id,$member_id1,0,0,0,0)";
               $reg_fetch1 = $sql->query($reg1) or die($sql->error);

               $reg2 = "INSERT INTO session_(main_id,member_id,session_id) VALUES($main_id,$member_id1,'')";
               $reg_fetch2 = $sql->query($reg2) or die($sql->error);

               $token = $this->generateToken(35);
               $reg3 = "INSERT INTO register(member_id,email,token) VALUES('$member_id1','$email1','$token')";
               $reg_fetch3 = $sql->query($reg3) or die($sql->error);

               $this->sendMail($name1,$email1,$user1,$pass1,$token);
           }
   }
   function display_image($type,$file)
   {
      header('Content-Type:'.$type);
      header('Content-Length: ' . filesize($file));
      readfile($file);
   }
   function simplewaf($input)
   {   //vuln for boolean based blind
       $filter = array("/UNION/i","/SELECT/i","/ORDER/i","/BY/i","/INFORMATION_SCHEMA/i",
                       "/AND/i","/SCRIPT/i","/<IMG/i","/SRC=/i","/<SVG/i","/ONCLICK/i");
       foreach($filter as $sqlixss)
       {
        if(preg_match($sqlixss,$input))
        {
            $newvalue = " ";
            return $newvalue;
        }
       }
       return $input;
   }
   function json_converter($input)
   {
        $en_json = json_encode($input);
        $dec_json = json_decode($en_json);
        $this->json = $dec_json;
   }
   function getJson()
   {
       return $this->json;
   }
   function filtration($input)
   {
       $char = "/'/i";
       return preg_replace($char,"",$input);
   }
function generateToken($strLength)
{
    $char = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    $char_length = strlen($char);
    $getString = '';
    $token = '';
    for ($i = 0; $i < 25; $i++) {
        $randomChars = bin2hex($char[mt_rand(0, $char_length - 1)]);
        $getString .= $randomChars; 
    }                   
    $getToken = base64_encode($getString); // 40 1st Character
    $gt = strlen($getToken); // 40 length character
    if($gt!=$strLength) { // gt != user input desire
        for ($i = 0; $i < $strLength; $i++) {  // Generate for 2nd time (get chars from 1st step)
            $process = $getToken[mt_rand(0, $gt - 1)]; 
            $token .= $process; // user input desired chars
        }
    }
    return "_EGF_".$token."-token"; // Token Output
}
function vcode_gen($strLength)
{
    $char = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    $char_length = strlen($char);
    $getString = '';
    $token = '';
    for ($i = 0; $i < 25; $i++) {
        $randomChars = bin2hex($char[mt_rand(0, $char_length - 1)]);
        $getString .= $randomChars; 
    }                   
    $getToken = base64_encode($getString); // 40 1st Character
    $gt = strlen($getToken); // 40 length character
    if($gt!=$strLength) { // gt != user input desire
        for ($i = 0; $i < $strLength; $i++) {  // Generate for 2nd time (get chars from 1st step)
            $process = $getToken[mt_rand(0, $gt - 1)]; 
            $token .= $process; // user input desired chars
        }
    }
    return $token; // Token Output
}
function sendMail($name,$email,$user1,$pass1,$token)
{
    $xmlparse = <<<XML
    <?xml version="1.0" encoding="UTF-8"?>
      <Registration>
          <name>$name</name>
          <user>$user1</user>
          <pass>$pass1</pass>
          <email>$email</email>
          <token>$token</token>
    </Registration>
    XML;

    $ch = curl_init();
    curl_setopt($ch,CURLOPT_HEADER,0);
    curl_setopt($ch,CURLOPT_RETURNTRANSFER,1);
    curl_setopt($ch,CURLOPT_URL,"http://localhost/v2/email.php");
    curl_setopt($ch,CURLOPT_POST,1);
    curl_setopt($ch,CURLOPT_POSTFIELDS,$xmlparse);
    $data = curl_exec($ch);
    
    if(curl_errno($ch))
    {
        print curl_error($ch);
    }
    else
    {
        echo $data;
    }
    curl_close($ch);
 }
 function deact_proc()
 {
    unset($_SESSION['user_session']);
    unset($_SESSION['member_id']);
    unset($_SESSION['members']);
    unset($_SESSION['name']);
    unset($_SESSION['id']);
    session_destroy();
    echo "<script>alert('Your account successfully deleted!'); setTimeout(function() { window.location.replace('login.php') },500)</script>";
 }
}