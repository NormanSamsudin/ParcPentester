<?php
if($_SERVER['REQUEST_URI']==$_SERVER['PHP_SELF'])
{
    die(header('HTTP/1.1 403 Forbidden'));
}
else
{
    if(!isset($_POST['change']))
    {
    ?>
    <div id='chgpass'>
      <form action='' method='POST' autocomplete='off' required>
       <table>
        <tr><td><label>Old Password</label></td><td><input type='password' name='oldpass' value=''></td></tr>
        <tr><td><label>New Password</label></td><td><input type='password' name='newpass' value=''></td></tr>
        <tr><td><label>Re-enter Password</label></td><td><input type='password' name='rewpass' value=''></td></tr>
        <tr><td><input type='hidden' name='id' value='<?php echo $_SESSION['member_id'];?>'></td><td><input type='submit' name='change' value='Submit'></td></tr>
       </table>
      </form>
    </div>
    <?php
    }
    else
    {
        $exec->json_converter($_POST);
        $str = preg_replace("/'/i","//",$exec->getJson()->id);
        $chgcmd = "SELECT pass FROM members WHERE member_id='$str'";
        $chgres = $mysqli->query($chgcmd) or die($mysqli->error);
        $chg_row = $chgres->fetch_assoc();
        $old = sha1($exec->getJson()->oldpass);
        $new = sha1($exec->getJson()->newpass);
        $rew = sha1($exec->getJson()->rewpass);
        if($chg_row['pass']!=$old)
        {
            echo "<script>alert('Wrong password!'); setTimeout(function () { window.location.replace('".$_SERVER['PHP_SELF']."?action=chgpass') },500);</script>";
        }
        else if($new != $rew)
        {
            echo "<script>alert('New password you entered not same!'); setTimeout(function () { window.location.replace('".$_SERVER['PHP_SELF']."?action=chgpass') },500);</script>";
        }
        else
        {
            $chgupd = "UPDATE members SET pass='$new' WHERE member_id='".$_SESSION['member_id']."'";
            $mysqli->query($chgupd) or die($mysqli->error);
            echo "<script>alert('Password updated!'); setTimeout(function () { window.location.replace('".$_SERVER['PHP_SELF']."') },500);</script>";
        }
    }
}
?>