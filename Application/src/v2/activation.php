<!DOCTYPE html>
<html>
<head>
<script src="js/sweetalert2@10"></script>
</head>
<body>
<?php
require('function.php');
$exec = new exec_proc;
$activation = $exec->database($host,$username,$password,$database);
if((isset($_GET['email']) && isset($_GET['token'])) && ($_GET['email']!='' && $_GET['token']!=''))
{
    $email = stripslashes($exec->filtration($_GET['email']));
    $token = stripslashes($exec->filtration($_GET['token']));

    $sql = "SELECT member_id,token FROM register WHERE email='$email'";
    $fetch = $activation->query($sql) or die($activation->error);
    $data = $fetch->fetch_assoc();

    if((isset($data['member_id']) && isset($data['token'])) && ($data['token']==$token && $data['member_id']!=''))
    {
        $id = $data['member_id'];
        $sql_update = "UPDATE members SET activate=1 WHERE member_id=$id";
        $fetch_update = $activation->query($sql_update);
        if(!($activation->error))
        {
            $delete_token = "DELETE FROM register WHERE member_id=$id";
            $fetch_delete = $activation->query($delete_token);
            echo "<script>alert('Your account activated!');setTimeout(function(){ window.location.replace('index.php') },500);</script>";
        }
    }
    else
    {
        echo "<script>alert('Invalid activation code!');</script>";
    }
}
if((isset($_GET['email']) && isset($_GET['act'])) && ($_GET['email']!='' && $_GET['act']=='Resend'))
{
    $email = stripslashes($exec->filtration($_GET['email']));
    $checkq = "SELECT activate FROM members WHERE email='$email'";
    $checkf = $activation->query($checkq) or die($activation->error);
    $checkd = $checkf->fetch_assoc();
    if(isset($checkd['activate']) && $checkd['activate']==0)
    {
        $sql = "SELECT member_id FROM register WHERE email='$email'";
        $fetch = $activation->query($sql) or die($activation->error);
        $data = $fetch->fetch_assoc();
        $id = $data['member_id'];
        $token = $exec->generateToken(35);
        $sql1 = "UPDATE register SET token='$token'  WHERE email='$email' AND member_id=$id";
        $fetch1 = $activation->query($sql1);
        $sql2 = "SELECT user,pass,name FROM members WHERE email='$email'";
        $fetch2 = $activation->query($sql2);
        $data2 = $fetch2->fetch_assoc();
        if(!($activation->error))
        {
            //$urlx = $_SERVER['REQUEST_SCHEME'] . $_SERVER['HTTP_HOST'] ."/img/dec.jpg";
            $exec->sendMail($data2['name'],$email,$data2['user'],$data2['pass'],$token);
            echo "<script>
            Swal.fire({
                title: 'An activation link created!',
                text: 'Kindly please check your email',
                imageUrl: '../../img/dec.jpg',
                imageWidth: 400,
                imageHeight: 200,
                imageAlt: 'Custom image',
              })</script>";
        }
    }
    else if(isset($checkd['activate']) && $checkd['activate']==1)
    {
        echo "<script>
             Swal.fire(
            'Ehh?...',
            'Look like your account already activated!',
            'info')
            setTimeout(function(){ window.location.replace('activation.php'); },3000);</script>";
    }
    else
    {
        echo "<script>
             Swal.fire(
            'Hmm..',
            'This email not exist here.',
            'error')
            setTimeout(function(){ window.location.replace('activation.php'); },3000);</script>";   
    }
}
else
{
    ?>
    <form action='' method='GET'>
    <input type='email' name='email' required>
    <input type='submit' name='act' value='Resend'>
    </form>
    <?php
}
?>
</body>
</html>