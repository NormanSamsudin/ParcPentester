<!DOCTYPE html>
<html>
<script src="js/sweetalert2@10"></script>
<head>
<?php include 'function.php'; 
$exec = new exec_proc;
$creds = $exec -> database($host,$username,$password,$database);
echo "<title>Please login</title>";
include('css.php');
if(!isset($_SESSION['members']))
{
?>
</head>
<body>
<form action="" method="POST">
<center>
<table>
<tr>
<td><label>Username : </lable></td>
<td><input type="text" name="username" value="<?php if(isset($_POST['username'])) echo $_POST['username']; ?>" requred></td>
</tr>
<tr>
<td><label>Password : </lable></td>
<td><input type="password" name="password" value="" requred></td>
<tr>
<tr>
<td></td>
<td><input type="submit" name="login" value="Login "><a href='register.php'> Sign Up</a></td>
<tr>
</table>
</center>
</form>

<?php

if(isset($_POST['login']))
{
    $username = mysqli_real_escape_string($creds,$_POST['username']);
    $password = sha1($_POST['password']);

       $query = "SELECT id,name,member_id,activate FROM members WHERE (user='".$username."') AND (pass='".$password."')";
       $result = $creds -> query($query) or die("<script>alert('Invalid Credentials!')</script>");
       $row = $result -> fetch_assoc();
       if(isset($row['id']) && $row['activate']!=0)
       {
           $mmid = $row['member_id'];
           $session_token = base64_encode(bin2hex(mt_rand(999999,9999999999))); //generate random session_id
           $query1 = "UPDATE session_ SET session_id='$session_token' WHERE member_id='$mmid'";
           $result1 = $creds -> query($query1) or die($creds->error);
           $_SESSION['user_session'] = $session_token;
           $_SESSION['members'] = true;
           $_SESSION['name'] = $row['name'];
           $_SESSION['member_id'] = $row['member_id'];
           $_SESSION['id'] = $row['id'];
           setrawcookie("stylesheet","css.php");
           echo "<script>
           const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
              toast.addEventListener('mouseenter', Swal.stopTimer)
              toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
          })
          
          Toast.fire({
            icon: 'success',
            title: 'Signed in successfully'
          })
          setTimeout(function(){ window.location.replace('index.php'); },1500);
           </script>";
       }
       else if(isset($row['activate']) && $row['activate']==0)
       {
        echo "<script>
        Swal.fire({
            icon: 'error',
            title: 'Seems',
            text: 'Your account not activated!',
            footer: '<form action=activation.php method=GET><input type=text name=email value=><input type=submit name=act value=Resend></form>'
          })
        </script>";
       }
       else
       {
           echo "<script>
           Swal.fire({
            icon: 'error',
            title: 'Oops!',
            text: 'Invalid Credentials!',
            footer: '<p>Forgot <a href=forgot.php>Password </a>| </p>' + '<p> Register for<a href=register.php> new user</a></p>'
          })
           </script>";
       }
    }
}
else
{
    header('Location:index.php');
}
?>
</body>
</html>