<?php 

require 'function.php';

if(!isset($_SESSION['user_session'])) die(header('Location:login.php')); ?>

<html>

<head><title>Posting Area</title>
<?php if(isset($_COOKIE['stylesheet'])) include($_COOKIE['stylesheet']);?>
</head>

<body><center>

<?php

$exec = new exec_proc;

$postarea = $exec->database($host,$username,$password,$database);

if(!isset($_GET['post_id']))

{

if(isset($_POST['post']))

{

    $post_id = bin2hex(base64_encode(mt_rand(9999,999999999999)));

    $member_id = $_SESSION['member_id'];

    if(isset($_POST['content']) && $_POST['content']!=null && $_POST['content']!='')
    {
        $content = mysqli_real_escape_string($postarea,$_POST['content']);

        $query2 = "INSERT INTO posting(member_id,post_id,content) VALUES($member_id,'$post_id','$content')";
    
        $result2 = $postarea->query($query2) or die($postarea->error);
    
        echo "<script>window.location.replace('post.php');</script>";
    }
    else
    {
        echo "<script>alert('Blank post!');setTimeout(function(){ window.location.replace('post.php'); },500);</script>";
    }

}

else

{

    ?>

    <form action='' method='POST' onsubmit='checkPost();'>

    <label>Post something?</label></br>

    <textarea id='postContent' rows='10' cols='100' name='content' placeholder='Whats on your mind?'></textarea></br>

    <input type='submit' name='post' value='Post'>

    </form>

    <script>
       function checkPost()
       {
           var content = document.getElementById('postContent').value;
           if(content=='')
           {
               alert('Blank post!');
               event.preventDefault();
           }
       }
    </script>

    <?php

}

    $query = "SELECT * FROM posting ORDER BY id DESC";

    $result = $postarea->query($query) or die("No Posting yet!");

    while($postdata = $result->fetch_assoc())

    {

        $query1 = "SELECT name FROM members WHERE member_id='".$postdata['member_id']."'";

        $result1 = $postarea->query($query1);

        $postdata1 = $result1->fetch_assoc();



        echo "</br>From : ".strip_tags($postdata1['name'])."</br>Content : ".substr(htmlspecialchars($postdata['content']),0,25);

        echo "</br><a href=?post_id=".$postdata['post_id'].">Read full </a></br>";

        if($_SESSION['member_id']==$postdata['member_id'])

        {

            //delete post by id

            echo "<a href=?del_post=".$postdata['post_id']."> Delete</a></br>";

        }

    }

    if(isset($_GET['del_post']))

    {

        $delid = mysqli_real_escape_string($postarea,$_GET['del_post']);
        $origin_id = $_SESSION['member_id'];

        $validId = "SELECT * FROM posting WHERE post_id='$delid' AND member_id='$origin_id'";
        $validating = $postarea->query($validId);
        $validfetch = $validating->fetch_assoc();

        if(isset($validfetch['post_id']))
        {
            $query4 = "DELETE FROM posting WHERE post_id='$delid' AND member_id='$origin_id'";

            $result4 = $postarea->query($query4) or die("Failed to delete!");
            echo "<script>alert('Post deleted!');setTimeout(function(){ window.location.replace('post.php') },500);</script>";
        }
        else
        {
            echo "<script>alert('Cant delete others posting!');setTimeout(function(){ window.location.replace('post.php') },500);</script>";
        }

    }

    echo "</br><button onclick=window.location.replace('index.php')>Home</button>";

}

else

{

    $id = $exec->simplewaf($_GET['post_id']);

    $query3 = "SELECT * FROM posting WHERE post_id='$id'";

    $result3 = $postarea->query($query3) or exit(header('Location:error_handler.php?err=code&no=500'));

    $postdata3 = $result3->fetch_assoc();

    if(!isset($postdata3['post_id']) || $postdata3['post_id']=='')

    {

        header('Location:error_handler.php?err=code&no=404');

    }

    else

    {

        $memid = $postdata3['member_id'];

        $query0 = "SELECT name FROM members WHERE member_id='$memid'";

        $result0 = $postarea->query($query0);

        $postdata0 = $result0->fetch_assoc();

        echo "From : ".strip_tags($postdata0['name'])."</br></br>Posted:</br>";

        echo htmlspecialchars($postdata3['content'])."</br></br><button onclick='window.history.back()'>Back</button>";

    }

}

?>

</center>

</body>

</html>